<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#09090b">
    <title>TASKER PRO v9.0</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=Inter:wght@400;600&family=JetBrains+Mono:wght@700&display=swap');
        
        :root { --bg: #09090b; --card: #18181b; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            color: #e4e4e7;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        .anim-entry { animation: fadeSlideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; transform: translateZ(0); opacity: 0; }
        @keyframes fadeSlideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .glass-panel {
            background: rgba(24, 24, 27, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .brand-font { font-family: 'Space Grotesk', sans-serif; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }
        
        .tab-active { color: white; border-bottom: 2px solid #3b82f6; }
        .tab-inactive { color: #71717a; }
        .safe-top { padding-top: env(safe-area-inset-top); }

        /* Custom Inputs */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(59,130,246,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #27272a; border-radius: 2px; }

        .mood-btn.selected { transform: scale(1.2); filter: drop-shadow(0 0 8px rgba(255,255,255,0.3)); }
        
        .custom-checkbox {
            appearance: none; width: 20px; height: 20px; border: 2px solid #3f3f46; border-radius: 6px; display: grid; place-content: center; cursor: pointer; transition: all 0.2s;
        }
        .custom-checkbox:checked { background-color: #3b82f6; border-color: #3b82f6; }
        .custom-checkbox:checked::before {
            content: ""; width: 10px; height: 10px; box-shadow: inset 1em 1em white; transform-origin: bottom left; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        
        /* Danger Zone Pulse */
        .danger-pulse { animation: dangerGlow 2s infinite; }
        @keyframes dangerGlow { 0% { box-shadow: 0 0 5px #ef4444; } 50% { box-shadow: 0 0 20px #ef4444; } 100% { box-shadow: 0 0 5px #ef4444; } }
    </style>
</head>
<body class="pb-32 safe-top">

    <!-- Header with Countdown -->
    <header class="fixed top-0 w-full z-40 glass-panel pt-safe-top shadow-lg shadow-black/50">
        <div class="max-w-md mx-auto px-4 pt-3 pb-0">
            <div class="flex justify-between items-center mb-3">
                <div>
                    <h1 class="text-xl font-bold brand-font tracking-tight text-white">TASKER<span class="text-blue-500">.</span></h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="status-dot" class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                        </span>
                        <p class="text-[10px] text-zinc-400 font-mono tracking-widest uppercase" id="countdown-text">SYNCING...</p>
                    </div>
                </div>
                <!-- Time Left Gauge -->
                <div class="text-right">
                    <div class="text-[10px] text-zinc-500 uppercase font-bold">Study Time Left</div>
                    <div class="text-2xl font-mono font-bold text-white leading-none" id="mission-timer">--:--</div>
                </div>
            </div>
            <!-- Tabs -->
            <div class="flex border-b border-zinc-800">
                <button onclick="switchTab('tasks')" id="tab-btn-tasks" class="flex-1 pb-3 text-xs uppercase tracking-wider font-bold transition-colors tab-active">Tracker</button>
                <button onclick="switchTab('stats')" id="tab-btn-stats" class="flex-1 pb-3 text-xs uppercase tracking-wider font-bold transition-colors tab-inactive">Deep Analysis</button>
            </div>
        </div>
    </header>

    <div class="h-32"></div>

    <!-- VIEW: TASKS -->
    <main id="view-tasks" class="max-w-md mx-auto px-4 space-y-5 block">
        
        <!-- Day Selector -->
        <div class="flex gap-3 overflow-x-auto no-scrollbar pb-1" id="dayTabs"></div>

        <!-- üõå Sleep Input -->
        <div class="glass-panel rounded-xl p-4 border-l-4 border-l-purple-500 anim-entry">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-zinc-400 uppercase tracking-wider">Sleep (Hrs)</span>
                <span class="text-purple-400 font-mono font-bold" id="sleep-display">0 hrs</span>
            </div>
            <input type="range" min="0" max="12" step="0.5" id="sleep-slider" oninput="updateSleepDisplay(this.value)" onchange="saveSleep(this.value)">
            <p class="text-[10px] text-zinc-500 mt-2 text-right" id="sleep-comment">Track honestly.</p>
        </div>

        <!-- Daily Progress -->
        <div class="glass-panel rounded-xl p-4 flex items-center justify-between">
            <div>
                <div class="text-xs text-zinc-500 uppercase font-bold tracking-wider">Daily Goals</div>
                <div class="text-xl font-bold text-white" id="mini-progress-text">0%</div>
            </div>
            <div class="w-24 h-2 bg-zinc-800 rounded-full overflow-hidden">
                <div id="mini-progress-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- Task Slots -->
        <div id="slots-container" class="space-y-4"></div>

        <!-- ‚ö° Power Nap -->
        <div class="glass-panel rounded-xl p-4 border border-zinc-800 mt-4 anim-entry">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xs font-bold text-zinc-400 uppercase tracking-wider">Power Naps</h3>
                <span class="text-[10px] text-red-400" id="nap-warning"></span>
            </div>
            <div class="flex gap-2">
                <button onclick="addNap(15)" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 py-3 rounded-lg text-xs font-bold border border-zinc-700 transition-colors">+15 Min</button>
                <button onclick="addNap(30)" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 py-3 rounded-lg text-xs font-bold border border-zinc-700 transition-colors">+30 Min</button>
                <button onclick="resetNaps()" class="w-12 bg-red-900/20 text-red-400 rounded-lg border border-red-900/50">‚Ü∫</button>
            </div>
            <div class="mt-2 text-[10px] text-zinc-500 text-center" id="nap-total-display">Total: 0 min</div>
        </div>

        <!-- üß† Mood -->
        <div class="glass-panel rounded-xl p-4 text-center mt-4 mb-8 anim-entry">
            <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-wider mb-3">Day Review</h3>
            <div class="flex justify-center gap-8 text-3xl">
                <button onclick="setMood('bad')" id="mood-bad" class="mood-btn opacity-50">üò´</button>
                <button onclick="setMood('avg')" id="mood-avg" class="mood-btn opacity-50">üòê</button>
                <button onclick="setMood('good')" id="mood-good" class="mood-btn opacity-50">üî•</button>
            </div>
        </div>
        
        <div class="text-center pb-8">
            <button onclick="hardReset()" class="text-[10px] text-zinc-800 uppercase tracking-widest hover:text-red-500">Reset System</button>
        </div>
    </main>

    <!-- VIEW: STATS -->
    <main id="view-stats" class="max-w-md mx-auto px-4 space-y-6 hidden anim-entry">
        <!-- Main Score -->
        <div class="glass-panel rounded-2xl p-6 text-center shadow-2xl border-blue-500/20 border">
            <div class="text-xs text-blue-400 font-bold uppercase tracking-widest mb-2">Overall Efficiency</div>
            <div class="text-5xl font-bold text-white mb-1 brand-font" id="stats-score">0%</div>
            <p class="text-xs text-zinc-500 mt-2" id="stats-msg">Calculating data...</p>
        </div>

        <!-- Bio Rhythm Chart -->
        <div class="glass-panel rounded-2xl p-4">
            <h3 class="text-xs font-bold text-zinc-400 mb-2 ml-1">SLEEP VS PRODUCTIVITY</h3>
            <canvas id="bioChart" height="220"></canvas>
            <div class="mt-2 text-[10px] text-zinc-600 text-center">
                Bar = Sleep/Naps (Lower is better) | Line = Tasks Done
            </div>
        </div>

        <!-- Trend Chart -->
        <div class="glass-panel rounded-2xl p-4">
            <h3 class="text-xs font-bold text-zinc-400 mb-2 ml-1">CONSISTENCY TREND</h3>
            <canvas id="performanceChart" height="180"></canvas>
        </div>

        <!-- Summary -->
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-zinc-900 rounded-xl p-4 border border-zinc-800">
                <div class="text-zinc-500 text-xs mb-1">Total Naps</div>
                <div class="text-xl font-bold text-red-400" id="stat-naps">0m</div>
            </div>
            <div class="bg-zinc-900 rounded-xl p-4 border border-zinc-800">
                <div class="text-zinc-500 text-xs mb-1">Tasks Crushed</div>
                <div class="text-xl font-bold text-emerald-400" id="stat-done">0</div>
            </div>
        </div>
    </main>

    <!-- SCHEDULING MODAL -->
    <div id="schedule-modal" class="fixed inset-0 z-[60] hidden flex flex-col justify-end sm:justify-center bg-black/80 backdrop-blur-sm">
        <div class="w-full sm:max-w-md mx-auto glass-panel p-6 rounded-t-2xl sm:rounded-2xl shadow-2xl border-t border-blue-500/50 anim-entry">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white">Reschedule Task</h3>
                <button onclick="closeModal()" class="text-zinc-400 bg-zinc-800 p-2 rounded-full">‚úï</button>
            </div>
            <div class="space-y-4 mb-6">
                <select id="modal-day-select" class="w-full bg-zinc-900 border border-zinc-700 rounded-xl p-3 text-white outline-none"></select>
                <select id="modal-slot-select" class="w-full bg-zinc-900 border border-zinc-700 rounded-xl p-3 text-white outline-none">
                    <option value="0">Morning Grind (04-07 AM)</option>
                    <option value="1">GK & Strategy (09-02 PM)</option>
                    <option value="2">Deep Theory (02:30-07 PM)</option>
                    <option value="3">Night Review (08-10 PM)</option>
                </select>
            </div>
            <button onclick="confirmSchedule()" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl">Confirm Move</button>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const CORE_TASKS = ["DC Generator", "DC Motor", "Alternator", "1-Phase Motor", "3-Phase Induction"];
        
        // --- REAL-TIME SCHEDULE CONFIG ---
        // Format: start hour, start min, end hour, end min
        const SCHEDULE_SLOTS = [
            { sH: 4, sM: 0, eH: 7, eM: 0 },    // 04:00 - 07:00 (3h)
            { sH: 9, sM: 0, eH: 14, eM: 0 },   // 09:00 - 14:00 (5h)
            { sH: 14, sM: 30, eH: 19, eM: 0 }, // 14:30 - 19:00 (4.5h)
            { sH: 20, sM: 0, eH: 22, eM: 0 }   // 20:00 - 22:00 (2h)
        ];

        // --- DATA & STATE ---
        const INITIAL_STATE = { 
            currentDay: 0, 
            days: Array.from({ length: 7 }, (_, i) => ({ 
                id: i, 
                date: 4 + i, 
                sleep: 0, 
                mood: null, 
                naps: 0,
                slots: [ 
                    { id: 's1', title: 'Morning Grind (04-07 AM)', tasks: CORE_TASKS.map(t => ({id: Date.now()+Math.random(), text: t, done: false})) }, 
                    { id: 's2', title: 'GK & Strategy (09-02 PM)', tasks: [] }, 
                    { id: 's3', title: 'Deep Theory (02:30-07 PM)', tasks: [] }, 
                    { id: 's4', title: 'Night Review (08-10 PM)', tasks: [] } 
                ] 
            })) 
        };

        let appState;
        let chart1 = null;
        let chart2 = null;

        // --- SAFE LOAD ---
        try {
            const stored = localStorage.getItem('tasker_pro_v9');
            if (stored) {
                appState = JSON.parse(stored);
                if(!appState.days || appState.days.length !== 7) throw new Error("Invalid Data");
            } else {
                appState = JSON.parse(JSON.stringify(INITIAL_STATE));
            }
        } catch (e) {
            console.log("Resetting data structure...");
            appState = JSON.parse(JSON.stringify(INITIAL_STATE));
        }

        // --- AUDIO ---
        const playSound = (type) => {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); const now = audioCtx.currentTime;
            
            if (type === 'click') { 
                osc.frequency.setValueAtTime(800, now); gain.gain.setValueAtTime(0.05, now); osc.start(); osc.stop(now + 0.05); 
            } else if (type === 'done') { 
                osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now + 0.1); 
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4); osc.start(); osc.stop(now + 0.4); 
                confetti({ particleCount: 80, spread: 60, origin: { y: 0.7 }, colors: ['#3b82f6', '#10b981'] });
            }
            osc.connect(gain); gain.connect(audioCtx.destination);
        };

        // --- LOGIC ---
        const save = () => { localStorage.setItem('tasker_pro_v9', JSON.stringify(appState)); updateUI(); };
        const hardReset = () => { if(confirm("DELETE ALL DATA? This cannot be undone.")) { localStorage.removeItem('tasker_pro_v9'); location.reload(); }};
        
        const toggleTask = (d, s, t) => { const tasks = appState.days[d].slots[s].tasks; const task = tasks.find(x => x.id === t); if(task){ task.done = !task.done; playSound(task.done?'done':'click'); save(); }};
        const deleteTask = (d, s, t, e) => { e.stopPropagation(); if(confirm("Remove task?")) { appState.days[d].slots[s].tasks = appState.days[d].slots[s].tasks.filter(x => x.id !== t); save(); }};
        const addTask = (d, s, iId) => { const el = document.getElementById(iId); const val = el.value.trim(); if(val) { appState.days[d].slots[s].tasks.push({id: Date.now(), text: val, done: false}); el.value = ''; playSound('click'); save(); }};

        const updateSleepDisplay = (v) => { 
            document.getElementById('sleep-display').innerText = v + " hrs"; 
            document.getElementById('sleep-comment').innerText = v > 8 ? "Too much sleep = wasted time!" : v < 5 ? "Dangerous. Sleep more." : "Optimal range.";
            document.getElementById('sleep-comment').className = v > 8 ? "text-[10px] mt-2 text-right text-red-400 font-bold" : "text-[10px] mt-2 text-right text-zinc-500";
        };
        const saveSleep = (v) => { appState.days[appState.currentDay].sleep = parseFloat(v); save(); };
        
        const addNap = (m) => { appState.days[appState.currentDay].naps += m; playSound('click'); save(); };
        const resetNaps = () => { appState.days[appState.currentDay].naps = 0; playSound('click'); save(); };
        const setMood = (m) => { appState.days[appState.currentDay].mood = m; playSound('click'); save(); };

        const openReschedule = (d, s, t, e) => {
            e.stopPropagation(); pendingTask = {d, s, t};
            const ds = document.getElementById('modal-day-select');
            ds.innerHTML = appState.days.map((day, i) => `<option value="${i}">Day ${day.date}</option>`).join('');
            ds.value = d;
            document.getElementById('schedule-modal').classList.remove('hidden');
            document.getElementById('schedule-modal').classList.add('flex');
        };
        const closeModal = () => { document.getElementById('schedule-modal').classList.add('hidden'); document.getElementById('schedule-modal').classList.remove('flex'); };
        const confirmSchedule = () => {
            if(!pendingTask) return;
            const tD = document.getElementById('modal-day-select').value; const tS = document.getElementById('modal-slot-select').value;
            const srcTasks = appState.days[pendingTask.d].slots[pendingTask.s].tasks;
            const tIdx = srcTasks.findIndex(x => x.id === pendingTask.t);
            if(tIdx > -1) {
                const [moved] = srcTasks.splice(tIdx, 1);
                appState.days[tD].slots[tS].tasks.push(moved);
                playSound('click'); save(); closeModal();
            }
        };

                // --- REAL-TIME LOGIC (The Brain) ---
        const updateTimer = () => {
            const now = new Date();
            const currentMins = now.getHours() * 60 + now.getMinutes();
            const currentSecs = now.getSeconds();
            
            let totalRemainingMins = 0;
            let status = "REST TIME";
            let color = "text-zinc-500";
            let dotColor = "bg-zinc-500";
            let activeSlotEnd = null;

            // Calculate remaining study time for the day
            SCHEDULE_SLOTS.forEach(slot => {
                const sTime = slot.sH * 60 + slot.sM;
                const eTime = slot.eH * 60 + slot.eM;
                
                if (currentMins < sTime) {
                    // Slot is in future
                    totalRemainingMins += (eTime - sTime);
                } else if (currentMins >= sTime && currentMins < eTime) {
                    // Currently INSIDE this slot
                    totalRemainingMins += (eTime - currentMins);
                    status = "STUDY MODE ON";
                    color = "text-white";
                    dotColor = "bg-red-500 animate-ping";
                    activeSlotEnd = eTime;
                }
                // If currentMins > eTime, slot is passed, add 0
            });

            // Specific logic for before 4AM
            if (now.getHours() < 4) {
                status = "SLEEP / PREP";
                color = "text-purple-400";
                dotColor = "bg-purple-500";
                // Show full 14.5 hours
                totalRemainingMins = (3+5+4.5+2) * 60;
            } 
            // Logic for End of Day (> 10 PM)
            else if (now.getHours() >= 22) {
                status = "DAY ENDED";
                color = "text-zinc-600";
                totalRemainingMins = 0;
            }
            // Logic for Breaks (Between slots)
            else if (status === "REST TIME") {
                color = "text-yellow-500";
                status = "BREAK TIME";
                dotColor = "bg-yellow-500";
            }

            const h = Math.floor(totalRemainingMins / 60);
            const m = Math.floor(totalRemainingMins % 60);
            // Sync seconds visually
            const s = 59 - currentSecs; 

            document.getElementById('mission-timer').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            document.getElementById('mission-timer').className = `text-2xl font-mono font-bold leading-none ${color}`;
            document.getElementById('countdown-text').innerText = status;
            
            // Dot color update
            const dotHTML = status.includes("STUDY") 
                ? `<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>`
                : `<span class="relative inline-flex rounded-full h-2 w-2 ${dotColor}"></span>`;
            document.getElementById('status-dot').innerHTML = dotHTML;
        };
        setInterval(updateTimer, 1000);

        // --- UI & CHARTS ---
        const switchTab = (t) => {
            document.getElementById('view-tasks').style.display = t==='tasks'?'block':'none';
            document.getElementById('view-stats').style.display = t==='stats'?'block':'none';
            document.getElementById('tab-btn-tasks').className = `flex-1 pb-3 text-xs uppercase tracking-wider font-bold transition-colors ${t==='tasks'?'tab-active':'tab-inactive'}`;
            document.getElementById('tab-btn-stats').className = `flex-1 pb-3 text-xs uppercase tracking-wider font-bold transition-colors ${t==='stats'?'tab-active':'tab-inactive'}`;
            if(t==='stats') renderCharts();
        };

        const renderCharts = () => {
            const labels = appState.days.map(d => `D${d.date}`);
            const effData = appState.days.map(d => {
                const all = d.slots.flatMap(s=>s.tasks).length;
                const done = d.slots.flatMap(s=>s.tasks).filter(t=>t.done).length;
                return all ? (done/all)*100 : 0;
            });
            const sleepData = appState.days.map(d => (d.sleep + (d.naps/60)));

            // Overall Score
            const totalTasks = appState.days.flatMap(d=>d.slots.flatMap(s=>s.tasks)).length;
            const totalDone = appState.days.flatMap(d=>d.slots.flatMap(s=>s.tasks)).filter(t=>t.done).length;
            const globalEff = totalTasks ? Math.round((totalDone/totalTasks)*100) : 0;
            document.getElementById('stats-score').innerText = globalEff + "%";
            document.getElementById('stats-score').className = `text-5xl font-bold mb-1 brand-font ${globalEff<50?'text-red-500':globalEff<80?'text-blue-400':'text-emerald-400'}`;
            
            // Bio Chart (Mixed)
            if(chart1) chart1.destroy();
            chart1 = new Chart(document.getElementById('bioChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Sleep+Naps (hrs)', data: sleepData, backgroundColor: 'rgba(168, 85, 247, 0.5)', borderRadius: 4, order: 2 },
                        { label: 'Efficiency %', data: effData, type: 'line', borderColor: '#3b82f6', borderWidth: 2, tension: 0.3, order: 1 }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, grid: {color: '#27272a'} }, x: { grid: {display: false} } }, plugins: { legend: {display: false} } }
            });

            // Trend Chart
            if(chart2) chart2.destroy();
            chart2 = new Chart(document.getElementById('performanceChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Performance', data: effData, borderColor: globalEff > 70 ? '#10b981' : '#ef4444', backgroundColor: 'rgba(255,255,255,0.05)', fill: true, tension: 0.4 }]
                },
                options: { responsive: true, scales: { y: { display: false }, x: { display: false } }, plugins: { legend: {display: false} } }
            });

            document.getElementById('stat-naps').innerText = appState.days.reduce((a,b) => a + (b.naps||0), 0) + "m";
            document.getElementById('stat-done').innerText = totalDone;
        };

        const updateUI = () => {
            const curD = appState.days[appState.currentDay];
            
            // 1. Day Tabs (Color Logic Here)
            document.getElementById('dayTabs').innerHTML = appState.days.map((d, i) => {
                const ts = d.slots.flatMap(s=>s.tasks); const dn = ts.filter(t=>t.done).length; const p = ts.length ? (dn/ts.length)*100 : 0;
                
                // Color Logic: Days 8,9,10 (Index 4,5,6) are Red
                const isDangerZone = i >= 4; // Because Day 8 is at index 4 (0=Day4, 1=Day5, 2=Day6, 3=Day7, 4=Day8)
                const baseColor = isDangerZone ? 'bg-red-900/40 border-red-800 text-red-400' : 'bg-zinc-800 text-zinc-500 border-zinc-700';
                const activeColor = i===appState.currentDay 
                    ? (isDangerZone ? 'bg-red-600 text-white shadow-lg shadow-red-900/50 scale-105' : 'bg-blue-600 text-white shadow-lg shadow-blue-900/50 scale-105')
                    : `border ${baseColor}`;

                return `<button onclick="appState.currentDay=${i};save()" class="flex-shrink-0 w-14 h-14 rounded-xl flex flex-col items-center justify-center transition-all ${activeColor}">
                    <span class="text-[9px] font-bold uppercase">Day</span><span class="text-lg font-bold brand-font">${d.date}</span>
                    <div class="w-8 h-1 bg-black/20 mt-1 rounded-full overflow-hidden"><div class="h-full bg-white/80" style="width: ${p}%"></div></div>
                </button>`;
            }).join('');

            // 2. Sleep & Naps
            document.getElementById('sleep-slider').value = curD.sleep;
            updateSleepDisplay(curD.sleep);
            document.getElementById('nap-total-display').innerText = `Total: ${curD.naps} min`;
            document.getElementById('nap-warning').innerText = curD.naps > 45 ? "‚ö†Ô∏è Overdose" : "";

            // 3. Mood
            ['bad','avg','good'].forEach(m => {
                const btn = document.getElementById(`mood-${m}`);
                btn.classList.remove('selected', 'opacity-100', 'grayscale-0');
                if(curD.mood === m) {
                    btn.classList.add('selected', 'opacity-100');
                } else {
                    btn.classList.add('opacity-50');
                }
            });

            // 4. Progress
            const dTasks = curD.slots.flatMap(s=>s.tasks); const dDone = dTasks.filter(t=>t.done).length; const dPct = dTasks.length ? Math.round((dDone/dTasks.length)*100) : 0;
            document.getElementById('mini-progress-text').innerText = `${dPct}%`;
            document.getElementById('mini-progress-bar').style.width = `${dPct}%`;

            // 5. Tasks
            document.getElementById('slots-container').innerHTML = curD.slots.map((slot, sIdx) => {
                const iId = `in-${appState.currentDay}-${sIdx}`;
                return `
                <div class="anim-entry glass-panel rounded-xl overflow-hidden" style="animation-delay: ${sIdx * 0.05}s">
                    <div class="bg-zinc-800/50 px-4 py-2 border-b border-zinc-700/50 flex justify-between items-center">
                        <h3 class="font-bold text-xs uppercase tracking-wider ${sIdx===3?'text-purple-400':'text-blue-400'}">${slot.title}</h3>
                        <span class="text-[10px] bg-zinc-800 text-zinc-400 px-2 rounded">${slot.tasks.filter(t=>t.done).length}/${slot.tasks.length}</span>
                    </div>
                    <div class="p-3 space-y-2">
                        ${slot.tasks.map(t => `
                            <div onclick="toggleTask(${appState.currentDay},${sIdx},${t.id})" class="flex items-center gap-3 p-3 rounded-lg border border-zinc-800 bg-zinc-900/40 hover:bg-zinc-800 transition-all cursor-pointer ${t.done?'opacity-50':''}">
                                <input type="checkbox" class="custom-checkbox" ${t.done?'checked':''} readonly>
                                <span class="flex-1 text-sm font-medium ${t.done?'line-through text-zinc-500':'text-zinc-200'}">${t.text}</span>
                                <div class="flex gap-3">
                                    <button onclick="openReschedule(${appState.currentDay},${sIdx},${t.id},event)" class="text-zinc-600 hover:text-blue-400 text-xs">Move</button>
                                    <button onclick="deleteTask(${appState.currentDay},${sIdx},${t.id},event)" class="text-zinc-600 hover:text-red-400 text-xs">Del</button>
                                </div>
                            </div>
                        `).join('')}
                        <div class="flex gap-2 mt-2">
                            <input id="${iId}" type="text" placeholder="Add task..." class="flex-1 bg-zinc-950 border border-zinc-800 rounded-lg px-3 py-2 text-sm text-white focus:outline-none" onkeydown="if(event.key==='Enter') addTask(${appState.currentDay},${sIdx},'${iId}')">
                            <button onclick="addTask(${appState.currentDay},${sIdx},'${iId}')" class="bg-zinc-800 text-zinc-400 px-3 rounded-lg font-bold hover:bg-white hover:text-black transition-colors">+</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        };

        updateUI();
    </script>
</body>
</html>
