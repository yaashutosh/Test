<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#09090b">
    <title>TASKER v8.0</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Confetti Logic -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=Inter:wght@400;600&family=JetBrains+Mono:wght@700&display=swap');
        
        :root { --bg: #09090b; --card: #18181b; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            color: #e4e4e7;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        .anim-entry { animation: fadeSlideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; transform: translateZ(0); opacity: 0; }
        @keyframes fadeSlideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .glass-panel {
            background: rgba(24, 24, 27, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .brand-font { font-family: 'Space Grotesk', sans-serif; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }
        
        .tab-active { color: white; border-bottom: 2px solid #3b82f6; }
        .tab-inactive { color: #71717a; }
        .safe-top { padding-top: env(safe-area-inset-top); }

        /* Range Slider Styling */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(59,130,246,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #27272a; border-radius: 2px; }

        /* Mood Selection */
        .mood-btn.selected { transform: scale(1.2); filter: drop-shadow(0 0 8px rgba(255,255,255,0.3)); }
        
        /* Checkbox Custom */
        .custom-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #3f3f46;
            border-radius: 6px;
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .custom-checkbox:checked::before {
            content: "";
            width: 10px;
            height: 10px;
            box-shadow: inset 1em 1em white;
            transform-origin: bottom left;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
    </style>
</head>
<body class="pb-32 safe-top">

    <!-- Header with Countdown -->
    <header class="fixed top-0 w-full z-40 glass-panel pt-safe-top shadow-lg shadow-black/50">
        <div class="max-w-md mx-auto px-4 pt-3 pb-0">
            <div class="flex justify-between items-center mb-3">
                <div>
                    <h1 class="text-xl font-bold brand-font tracking-tight text-white">TASKER<span class="text-blue-500">.</span></h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                        </span>
                        <p class="text-[10px] text-zinc-400 font-mono tracking-widest uppercase" id="countdown-text">CALCULATING...</p>
                    </div>
                </div>
                <!-- Time Left Gauge -->
                <div class="text-right">
                    <div class="text-[10px] text-zinc-500 uppercase font-bold">Time Left</div>
                    <div class="text-2xl font-mono font-bold text-white leading-none" id="mission-timer">--:--</div>
                </div>
            </div>
            <!-- Tabs -->
            <div class="flex border-b border-zinc-800">
                <button onclick="switchTab('tasks')" id="tab-btn-tasks" class="flex-1 pb-3 text-xs uppercase tracking-wider font-bold transition-colors tab-active">Tracker</button>
                <button onclick="switchTab('stats')" id="tab-btn-stats" class="flex-1 pb-3 text-xs uppercase tracking-wider font-bold transition-colors tab-inactive">Analysis</button>
            </div>
        </div>
    </header>

    <div class="h-32"></div>

    <!-- VIEW: TASKS -->
    <main id="view-tasks" class="max-w-md mx-auto px-4 space-y-5 block">
        
        <!-- Day Selector -->
        <div class="flex gap-3 overflow-x-auto no-scrollbar pb-1" id="dayTabs"></div>

        <!-- üõå Sleep Input (Top) -->
        <div class="glass-panel rounded-xl p-4 border-l-4 border-l-purple-500 anim-entry">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-zinc-400 uppercase tracking-wider">Last Night's Sleep</span>
                <span class="text-purple-400 font-mono font-bold" id="sleep-display">0 hrs</span>
            </div>
            <input type="range" min="0" max="12" step="0.5" id="sleep-slider" oninput="updateSleepDisplay(this.value)" onchange="saveSleep(this.value)">
        </div>

        <!-- Daily Progress -->
        <div class="glass-panel rounded-xl p-4 flex items-center justify-between">
            <div>
                <div class="text-xs text-zinc-500 uppercase font-bold tracking-wider">Task Completion</div>
                <div class="text-xl font-bold text-white" id="mini-progress-text">0%</div>
            </div>
            <div class="w-24 h-2 bg-zinc-800 rounded-full overflow-hidden">
                <div id="mini-progress-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- Task Slots Container -->
        <div id="slots-container" class="space-y-4">
            <!-- Slots will be injected here by JS -->
        </div>

        <!-- ‚ö° Power Nap Tracker -->
        <div class="glass-panel rounded-xl p-4 border border-zinc-800 mt-4 anim-entry">
            <h3 class="text-xs font-bold text-zinc-400 uppercase tracking-wider mb-3">Power Nap Zone</h3>
            <div class="flex gap-2">
                <button onclick="addNap(15)" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 py-2 rounded-lg text-xs font-bold border border-zinc-700 transition-colors">+15 Min</button>
                <button onclick="addNap(30)" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 py-2 rounded-lg text-xs font-bold border border-zinc-700 transition-colors">+30 Min</button>
            </div>
            <div class="mt-2 text-[10px] text-zinc-500 text-center" id="nap-total-display">Total Naps: 0 min</div>
        </div>

        <!-- üß† Mood / Day Review (Bottom) -->
        <div class="glass-panel rounded-xl p-4 text-center mt-4 mb-8 anim-entry">
            <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-wider mb-3">How was today?</h3>
            <div class="flex justify-center gap-6 text-3xl">
                <button onclick="setMood('bad')" id="mood-bad" class="mood-btn opacity-50 hover:opacity-100 transition-all">üòû</button>
                <button onclick="setMood('avg')" id="mood-avg" class="mood-btn opacity-50 hover:opacity-100 transition-all">üòê</button>
                <button onclick="setMood('good')" id="mood-good" class="mood-btn opacity-50 hover:opacity-100 transition-all">üî•</button>
            </div>
        </div>
    </main>

    <!-- VIEW: STATS -->
    <main id="view-stats" class="max-w-md mx-auto px-4 space-y-6 hidden anim-entry">
        <!-- Main Stats Card -->
        <div class="glass-panel rounded-2xl p-6 text-center shadow-2xl border-blue-500/20 border">
            <div class="text-xs text-blue-400 font-bold uppercase tracking-widest mb-2">Efficiency Score</div>
            <div class="text-4xl font-bold text-white mb-1" id="stats-score">0%</div>
            <p class="text-sm text-zinc-400" id="stats-msg">Calculating...</p>
        </div>

        <!-- Productivity Graph -->
        <div class="glass-panel rounded-2xl p-4">
            <h3 class="text-xs font-bold text-zinc-400 mb-2 ml-1">PERFORMANCE TREND</h3>
            <canvas id="performanceChart" height="200"></canvas>
            <div class="flex justify-center gap-4 mt-2 text-[10px] text-zinc-500">
                <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Efficiency</div>
            </div>
        </div>

        <!-- Bio Stats -->
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-zinc-900 rounded-xl p-4 border border-zinc-800">
                <div class="text-zinc-500 text-xs mb-1">Avg. Sleep</div>
                <div class="text-xl font-bold text-purple-400" id="stat-sleep">0h</div>
            </div>
            <div class="bg-zinc-900 rounded-xl p-4 border border-zinc-800">
                <div class="text-zinc-500 text-xs mb-1">Tasks Done</div>
                <div class="text-xl font-bold text-emerald-400" id="stat-done">0</div>
            </div>
        </div>
    </main>

    <!-- SCHEDULING MODAL -->
    <div id="schedule-modal" class="fixed inset-0 z-[60] hidden flex flex-col justify-end sm:justify-center bg-black/80 backdrop-blur-sm">
        <div class="w-full sm:max-w-md mx-auto glass-panel p-6 rounded-t-2xl sm:rounded-2xl shadow-2xl border-t border-blue-500/50 anim-entry">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white">üöÄ Reschedule Task</h3>
                <button onclick="closeModal()" class="text-zinc-400 bg-zinc-800 p-2 rounded-full hover:text-white">‚úï</button>
            </div>
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-xs text-zinc-400 mb-1 font-bold">Target Day</label>
                    <select id="modal-day-select" class="w-full bg-zinc-900 border border-zinc-700 rounded-xl p-3 text-white outline-none"></select>
                </div>
                <div>
                    <label class="block text-xs text-zinc-400 mb-1 font-bold">Target Slot</label>
                    <select id="modal-slot-select" class="w-full bg-zinc-900 border border-zinc-700 rounded-xl p-3 text-white outline-none">
                        <option value="0">Morning Grind (04-07 AM)</option>
                        <option value="1">GK & Strategy (09-02 PM)</option>
                        <option value="2">Deep Theory (02:30-07 PM)</option>
                        <option value="3">Night Review (08-10 PM)</option>
                    </select>
                </div>
            </div>
            <button onclick="confirmSchedule()" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-500 transition-colors">Confirm Move</button>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const CORE_TASKS = ["DC Generator", "DC Motor", "Alternator", "1-Phase Motor", "3-Phase Induction"];
        
        // --- DATA & STATE ---
        const INITIAL_STATE = { 
            currentDay: 0, 
            days: Array.from({ length: 7 }, (_, i) => ({ 
                id: i, 
                date: 4 + i, 
                sleep: 0, 
                mood: null, 
                naps: 0,
                slots: [ 
                    { id: 's1', title: 'Morning Grind (04-07 AM)', tasks: CORE_TASKS.map(t => ({id: Date.now()+Math.random(), text: t, done: false})) }, 
                    { id: 's2', title: 'GK & Strategy (09-02 PM)', tasks: [] }, 
                    { id: 's3', title: 'Deep Theory (02:30-07 PM)', tasks: [] }, 
                    { id: 's4', title: 'Night Review (08-10 PM)', tasks: [] } 
                ] 
            })) 
        };

        let appState = JSON.parse(localStorage.getItem('tasker_v8')) || INITIAL_STATE;
        
        // Migration to fix undefined fields if updating from old version
        appState.days.forEach(d => {
            if(d.sleep === undefined) d.sleep = 0;
            if(d.mood === undefined) d.mood = null;
            if(d.naps === undefined) d.naps = 0;
        });

        let pendingTask = null; // { dayIndex, slotIndex, taskId }
        let chartInstance = null;

        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playSound = (type) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); const now = audioCtx.currentTime;
            
            if (type === 'click') { 
                osc.frequency.setValueAtTime(600, now); gain.gain.setValueAtTime(0.05, now); osc.start(); osc.stop(now + 0.05); 
            } else if (type === 'done') { 
                osc.type = 'triangle'; osc.frequency.setValueAtTime(500, now); osc.frequency.linearRampToValueAtTime(1000, now + 0.1); 
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3); osc.start(); osc.stop(now + 0.3); 
                triggerConfetti();
            }
            osc.connect(gain); gain.connect(audioCtx.destination);
        };

        const triggerConfetti = () => {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#3b82f6', '#ffffff', '#71717a']
            });
        };

        // --- CORE FUNCTIONS ---
        const save = () => { localStorage.setItem('tasker_v8', JSON.stringify(appState)); updateUI(); };
        
        const toggleTask = (dayIdx, slotIdx, taskId) => { 
            const task = appState.days[dayIdx].slots[slotIdx].tasks.find(y => y.id === taskId); 
            if(task) {
                task.done = !task.done; 
                playSound(task.done ? 'done' : 'click'); 
                save(); 
            }
        };
        
        const deleteTask = (dayIdx, slotIdx, taskId, e) => { 
            e.stopPropagation(); 
            if(confirm('Delete this task?')) { 
                const slot = appState.days[dayIdx].slots[slotIdx]; 
                slot.tasks = slot.tasks.filter(y => y.id !== taskId); 
                save(); 
            } 
        };
        
        const addTask = (dayIdx, slotIdx, inputId) => { 
            const input = document.getElementById(inputId);
            const val = input.value.trim(); 
            if(val) { 
                appState.days[dayIdx].slots[slotIdx].tasks.push({id: Date.now(), text: val, done: false}); 
                input.value = ''; 
                playSound('click'); 
                save(); 
            } 
        };

        // --- HEALTH TRACKING ---
        const updateSleepDisplay = (val) => { document.getElementById('sleep-display').innerText = val + " hrs"; };
        const saveSleep = (val) => { appState.days[appState.currentDay].sleep = parseFloat(val); save(); };
        
        const addNap = (mins) => {
            appState.days[appState.currentDay].naps += mins;
            playSound('click');
            save();
        };

        const setMood = (mood) => {
            appState.days[appState.currentDay].mood = mood;
            playSound('click');
            save();
        };

        // --- RESCHEDULING LOGIC ---
        const openReschedule = (dayIdx, slotIdx, taskId, e) => {
            e.stopPropagation();
            pendingTask = { dayIdx, slotIdx, taskId };
            
            // Populate Day Select
            const daySelect = document.getElementById('modal-day-select');
            daySelect.innerHTML = appState.days.map((d, i) => 
                `<option value="${i}">Day ${d.date} (${i===appState.currentDay ? 'Today' : 'Future'})</option>`
            ).join('');
            
            daySelect.value = dayIdx; // Default to current
            document.getElementById('schedule-modal').classList.remove('hidden');
            document.getElementById('schedule-modal').classList.add('flex');
        };

        const closeModal = () => {
            document.getElementById('schedule-modal').classList.add('hidden');
            document.getElementById('schedule-modal').classList.remove('flex');
            pendingTask = null;
        };

        const confirmSchedule = () => {
            if(!pendingTask) return;
            const targetDay = parseInt(document.getElementById('modal-day-select').value);
            const targetSlot = parseInt(document.getElementById('modal-slot-select').value);

            // Find task object
            const sourceSlot = appState.days[pendingTask.dayIdx].slots[pendingTask.slotIdx];
            const taskIndex = sourceSlot.tasks.findIndex(t => t.id === pendingTask.taskId);
            
            if(taskIndex > -1) {
                const [task] = sourceSlot.tasks.splice(taskIndex, 1);
                appState.days[targetDay].slots[targetSlot].tasks.push(task);
                playSound('click');
                save();
                closeModal();
            }
        };

        // --- TIMER ---
        setInterval(() => {
            const now = new Date();
            const end = new Date(); end.setHours(22, 0, 0, 0); // 10 PM
            const start = new Date(); start.setHours(4, 0, 0, 0); // 4 AM

            let diff, statusText, color;

            if (now < start) {
                diff = start - now; statusText = "STARTS IN"; color = "text-yellow-400";
            } else if (now > end) {
                statusText = "REST TIME"; 
                document.getElementById('mission-timer').innerText = "00:00";
                document.getElementById('countdown-text').innerText = "MISSION COMPLETED";
                return;
            } else {
                diff = end - now; statusText = "MISSION ENDS IN";
                color = (diff < 1000*60*60*4) ? "text-red-500 animate-pulse" : "text-white";
            }

            const h = Math.floor(diff / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            document.getElementById('mission-timer').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            document.getElementById('mission-timer').className = `text-2xl font-mono font-bold leading-none ${color}`;
            document.getElementById('countdown-text').innerText = statusText;
        }, 1000);

        // --- UI RENDERING ---
        const switchTab = (t) => {
            document.getElementById('view-tasks').style.display = t==='tasks'?'block':'none';
            document.getElementById('view-stats').style.display = t==='stats'?'block':'none';
            document.getElementById('tab-btn-tasks').className = t==='tasks' ? 'flex-1 pb-3 text-xs uppercase font-bold tab-active' : 'flex-1 pb-3 text-xs uppercase font-bold tab-inactive';
            document.getElementById('tab-btn-stats').className =
