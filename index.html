<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0b0f19">
    <title>RVUNL Command v5</title>

    <link rel="manifest" href="data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22RVUNL%20Pro%22%2C%22short_name%22%3A%22RVUNL%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230b0f19%22%2C%22theme_color%22%3A%22%230b0f19%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fcdn-icons-png.flaticon.com%2F512%2F2921%2F2921222.png%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0b0f19; color: #e2e8f0; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .glass { background: rgba(11, 15, 25, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        
        /* Animations */
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .anim-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        /* Modal Glass */
        .modal-glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(16px); border: 1px solid rgba(59, 130, 246, 0.2); }
    </style>
</head>
<body class="pb-32 safe-area-top">

    <!-- Header -->
    <header class="fixed top-0 w-full z-40 glass pt-safe-area-top">
        <div class="max-w-3xl mx-auto px-4 py-3">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-lg font-bold font-[JetBrains_Mono] text-blue-400 tracking-tighter">RVUNL_v5 <span class="text-[10px] text-yellow-500 border border-yellow-500 px-1 rounded">SYNC</span></h1>
                <div class="flex gap-2">
                    <button onclick="installGuide()" class="text-xs bg-blue-900/50 text-blue-300 px-2 py-1 rounded border border-blue-800">App Mode</button>
                    <button onclick="hardReset()" class="text-xs text-red-500 font-mono">[RESET]</button>
                </div>
            </div>
            <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide" id="dayTabs"></div>
        </div>
    </header>

    <div class="h-36"></div>

    <!-- Main App -->
    <main class="max-w-3xl mx-auto px-4 space-y-6" id="app"></main>

    <!-- SCHEDULING MODAL (The new feature) -->
    <div id="schedule-modal" class="fixed inset-0 z-[60] hidden flex-col justify-end sm:justify-center bg-black/80 backdrop-blur-sm transition-opacity duration-300">
        <div class="w-full sm:max-w-md mx-auto modal-glass p-6 rounded-t-2xl sm:rounded-2xl shadow-2xl anim-slide-up border-t border-blue-500/50">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <span class="text-xl">ðŸš€</span> Reschedule Task
                    </h3>
                    <p class="text-xs text-blue-300 font-mono mt-1">Select destination for this task</p>
                </div>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white bg-slate-800 p-2 rounded-full">âœ•</button>
            </div>

            <div class="space-y-4 mb-6">
                <!-- Select Day -->
                <div>
                    <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider font-bold">Target Day</label>
                    <select id="modal-day-select" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white focus:border-blue-500 focus:outline-none appearance-none font-mono text-sm">
                        <!-- Options injected by JS -->
                    </select>
                </div>

                <!-- Select Slot -->
                <div>
                    <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider font-bold">Target Time Slot</label>
                    <select id="modal-slot-select" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white focus:border-blue-500 focus:outline-none appearance-none font-mono text-sm">
                        <option value="0">04:00 AM - 07:00 AM (Core)</option>
                        <option value="1">09:00 AM - 02:00 PM (GK)</option>
                        <option value="2">02:30 PM - 07:00 PM (Theory)</option>
                        <option value="3">08:00 PM - 10:00 PM (Night)</option>
                    </select>
                </div>
            </div>

            <button onclick="confirmSchedule()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-900/50 flex items-center justify-center gap-2 transition-all active:scale-95">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                Confirm Schedule
            </button>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-green-500/90 text-white px-4 py-2 rounded-full text-sm font-bold shadow-xl z-[70] transition-all duration-300 opacity-0 pointer-events-none translate-y-[-20px] backdrop-blur-md">
        Task Scheduled Successfully!
    </div>
    
    <!-- Install Guide -->
    <div id="install-toast" class="fixed bottom-0 w-full glass border-t border-blue-500/30 p-4 transform translate-y-full transition-transform duration-300 z-[60]">
        <div class="flex items-center gap-3 justify-between">
            <div class="text-sm text-slate-300">Tap <strong>Share/Menu</strong> -> <strong>Add to Home Screen</strong></div>
            <button onclick="document.getElementById('install-toast').classList.add('translate-y-full')" class="text-slate-500 px-2">âœ•</button>
        </div>
    </div>

    <script>
        // --- ðŸŽµ SOUND ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }
        const sfx = {
            click: () => playTone(800, 'triangle', 0.05),
            success: () => { playTone(523, 'sine', 0.1); setTimeout(() => playTone(1046, 'sine', 0.3), 100); },
            open: () => playTone(400, 'sine', 0.2), // Modal open sound
            warp: () => { playTone(300, 'sawtooth', 0.1); setTimeout(() => playTone(600, 'sawtooth', 0.2), 100); } // Teleport sound
        };

        // --- ðŸ’¾ DATA & STATE ---
        const START_DATE = 4;
        let appState = JSON.parse(localStorage.getItem('rvun_app_v5')) || null;
        let pendingTask = null; // Stores task to be moved

        // Initial Data Setup (If empty)
        if (!appState) {
            const core = ["DC Generator (à¤¦à¤¿à¤·à¥à¤Ÿ à¤§à¤¾à¤°à¤¾ à¤œà¤¨à¤¿à¤¤à¥à¤°)", "DC Motor (à¤¦à¤¿à¤·à¥à¤Ÿ à¤§à¤¾à¤°à¤¾ à¤®à¥‹à¤Ÿà¤°)", "Alternator (à¤ªà¥à¤°à¤¤à¥à¤¯à¤¾à¤µà¤°à¥à¤¤à¤•)", "1-Phase Motor", "3-Phase Induction"];
            const batches = [
                ["Charge & Static Electricity", "Resistors", "D.C. Theory", "Safety Devices", "Capacitor"],
                ["A.C. Theory", "Cells & Battery", "Magnetism", "Earthing", "Underground Cables"],
                ["Cables & Joints", "Soldering", "Transformer", "Winding", "Basic Electronics"],
                ["Diode & Rectifier", "Transistor", "Instruments", "Generation", "Transmission"]
            ];
            
            appState = {
                currentDay: 0,
                days: Array.from({ length: 7 }, (_, i) => ({
                    id: i, date: START_DATE + i,
                    slots: [
                        { title: 'Morning Core', time: '04-07 AM', color: 'blue', tasks: core.map(t=>({id: Date.now()+Math.random(), text: t, done: false})) },
                        { title: 'GK & Non-Tech', time: '09-02 PM', color: 'orange', tasks: [] },
                        { title: 'Theory', time: '02:30-07 PM', color: 'green', tasks: (i<4 ? batches[i] : []).map(t=>({id: Date.now()+Math.random(), text: t, done: false})) },
                        { title: 'Night Ops', time: '08-10 PM', color: 'purple', tasks: [{id: Date.now()+Math.random(), text: "MCQ & Review", done: false}] }
                    ]
                }))
            };
            save();
        }

        function save() { localStorage.setItem('rvun_app_v5', JSON.stringify(appState)); render(); }
        
        // --- SCHEDULING LOGIC ---
        function initSchedule(dIdx, sIdx, tId, event) {
            event.stopPropagation();
            const task = appState.days[dIdx].slots[sIdx].tasks.find(t => t.id === tId);
            pendingTask = { text: task.text, originalDay: dIdx, originalSlot: sIdx, originalId: tId };
            
            // Populate Modal Options
            const daySelect = document.getElementById('modal-day-select');
            daySelect.innerHTML = appState.days.map((d, i) => 
                `<option value="${i}">Day ${i+1} (${d.date}th) ${i === dIdx ? '(Current)' : ''}</option>`
            ).join('');
            
            // Set default to current day/slot
            daySelect.value = dIdx;
            document.getElementById('modal-slot-select').value = sIdx;

            // Show Modal
            const modal = document.getElementById('schedule-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            sfx.open();
        }

        function closeModal() {
            const modal = document.getElementById('schedule-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            pendingTask = null;
        }

        function confirmSchedule() {
            if (!pendingTask) return;
            
            const targetDayIdx = parseInt(document.getElementById('modal-day-select').value);
            const targetSlotIdx = parseInt(document.getElementById('modal-slot-select').value);
            
            // 1. Add to target
            appState.days[targetDayIdx].slots[targetSlotIdx].tasks.push({
                id: Date.now(),
                text: pendingTask.text,
                done: false,
                isRescheduled: true // Mark as scheduled
            });

            // 2. Mark original as scheduled (Optional: Visual feedback on original)
            const originalTask = appState.days[pendingTask.originalDay].slots[pendingTask.originalSlot].tasks.find(t => t.id === pendingTask.originalId);
            if(originalTask) originalTask.hasScheduledCopy = true;

            sfx.warp();
            save();
            closeModal();
            showToast(`Task moved to Day ${targetDayIdx + 1}!`);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-[-20px]'), 2000);
        }

        // --- STANDARD ACTIONS ---
        function toggleTask(dIdx, sIdx, tId) {
            const t = appState.days[dIdx].slots[sIdx].tasks.find(x => x.id === tId);
            t.done = !t.done; t.done ? sfx.success() : sfx.click(); save();
        }
        function deleteTask(dIdx, sIdx, tId, e) {
            e.stopPropagation();
            if(confirm('Delete?')) {
                const s = appState.days[dIdx].slots[sIdx];
                s.tasks = s.tasks.filter(x => x.id !== tId);
                save();
            }
        }
        function addTask(dIdx, sIdx, inputId) {
            const val = document.getElementById(inputId).value.trim();
            if(val) {
                appState.days[dIdx].slots[sIdx].tasks.push({ id: Date.now(), text: val, done: false });
                document.getElementById(inputId).value = '';
                sfx.click(); save();
            }
        }
        function hardReset() { if(confirm('Reset all data?')) { localStorage.removeItem('rvun_app_v5'); location.reload(); } }

        // --- RENDER ---
        function render() {
            const curDay = appState.days[appState.currentDay];
            
            // Render Tabs
            document.getElementById('dayTabs').innerHTML = appState.days.map((d, i) => {
                const active = i === appState.currentDay;
                const total = d.slots.flatMap(s=>s.tasks).length;
                const done = d.slots.flatMap(s=>s.tasks).filter(t=>t.done).length;
                const pct = total ? (done/total)*100 : 0;
                return `<button onclick="appState.currentDay=${i};save();window.scrollTo(0,0)" class="relative flex-shrink-0 w-14 h-14 rounded-xl flex flex-col items-center justify-center transition-all ${active ? 'bg-blue-600 text-white shadow-lg scale-105 border border-blue-400' : 'bg-slate-800 text-slate-400 border border-slate-700'}">
                    <span class="text-[9px] font-bold opacity-70">Day</span><span class="text-lg font-mono font-bold leading-none">${d.date}</span>
                    <div class="absolute bottom-1 w-8 h-0.5 bg-black/30 rounded-full"><div class="h-full bg-yellow-400" style="width:${pct}%"></div></div>
                </button>`;
            }).join('');

            // Render Content
            const app = document.getElementById('app');
            let html = `<div class="mb-6"><h2 class="text-xl font-bold text-white mb-1">Mission Dashboard</h2><div class="h-1.5 bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-blue-500 to-purple-500" style="width:${curDay.slots.flatMap(s=>s.tasks).length ? (curDay.slots.flatMap(s=>s.tasks).filter(t=>t.done).length/curDay.slots.flatMap(s=>s.tasks).length)*100 : 0}%"></div></div></div>`;

            html += curDay.slots.map((slot, sIdx) => {
                const theme = { blue: 'border-blue-500/20 bg-blue-900/5', orange: 'border-orange-500/20 bg-orange-900/5', green: 'border-green-500/20 bg-green-900/5', purple: 'border-purple-500/20 bg-purple-900/5' }[slot.color];
                const text = { blue: 'text-blue-400', orange: 'text-orange-400', green: 'text-green-400', purple: 'text-purple-400' }[slot.color];

                return `<div class="rounded-2xl border ${theme} p-4 mb-4 backdrop-blur-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold ${text}">${slot.title} <span class="text-[10px] text-slate-500 border border-slate-700 px-1 rounded ml-2">${slot.time}</span></h3>
                    </div>
                    <div class="space-y-2 mb-3">
                        ${slot.tasks.map(t => `
                            <div class="flex items-center gap-3 p-3 rounded-lg border transition-all ${t.done ? 'bg-slate-900/40 border-transparent opacity-60' : 'bg-slate-800/60 border-slate-700/50'} ${t.isRescheduled ? 'border-l-4 border-l-yellow-500' : ''}" onclick="toggleTask(${appState.currentDay}, ${sIdx}, ${t.id})">
                                <div class="w-5 h-5 rounded border-2 border-slate-600 flex items-center justify-center ${t.done ? 'bg-green-500 border-green-500' : ''}">${t.done ? 'âœ“' : ''}</div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium ${t.done ? 'line-through text-slate-500' : 'text-slate-200'}">${t.text}</div>
                                    ${t.hasScheduledCopy ? '<div class="text-[9px] text-yellow-500 flex items-center gap-1">âž” Scheduled for later</div>' : ''}
                                    ${t.isRescheduled ? '<div class="text-[9px] text-blue-400 flex items-center gap-1">â†© Rescheduled Task</div>' : ''}
                                </div>
                                <button onclick="initSchedule(${appState.currentDay}, ${sIdx}, ${t.id}, event)" class="p-2 text-slate-500 hover:text-yellow-400 transition-colors">ðŸ”–</button>
                                <button onclick="deleteTask(${appState.currentDay}, ${sIdx}, ${t.id}, event)" class="p-2 text-slate-500 hover:text-red-400">ðŸ—‘</button>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex gap-2"><input id="in-${sIdx}" placeholder="Add task..." class="bg-slate-900/50 border-none outline-none text-white w-full text-sm h-8 px-2 rounded" onkeydown="if(event.key==='Enter')addTask(${appState.currentDay},${sIdx},'in-${sIdx}')"><button onclick="addTask(${appState.currentDay},${sIdx},'in-${sIdx}')" class="bg-blue-600/20 text-blue-300 px-3 py-1 rounded text-xs font-bold">ADD</button></div>
                </div>`;
            }).join('');
            
            app.innerHTML = html;
        }

        // Install Prompt
        if (!window.matchMedia('(display-mode: standalone)').matches) setTimeout(() => document.getElementById('install-toast').classList.remove('translate-y-full'), 2000);
        render();
    </script>
</body>
</html>


