<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#09090b">
    <title>TASKER v7.0</title>

    <link rel="manifest" href="data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22TASKER%22%2C%22short_name%22%3A%22TASKER%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%2309090b%22%2C%22theme_color%22%3A%22%2309090b%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fcdn-icons-png.flaticon.com%2F512%2F906%2F906334.png%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=Inter:wght@400;600&display=swap');
        
        :root { --primary: #3b82f6; --bg: #09090b; --card: #18181b; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            color: #e4e4e7;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        /* Performance Optimizations */
        * { box-sizing: border-box; }
        .will-change-transform { will-change: transform, opacity; }

        .anim-entry { animation: fadeSlideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards; transform: translateZ(0); opacity: 0; }
        @keyframes fadeSlideUp { from { transform: translateY(15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .glass-panel {
            background: rgba(24, 24, 27, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .premium-shadow { box-shadow: 0 8px 30px -5px rgba(0, 0, 0, 0.6); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .brand-font { font-family: 'Space Grotesk', sans-serif; }
        
        .tab-active { color: white; border-bottom: 2px solid #3b82f6; }
        .tab-inactive { color: #71717a; }
        .safe-top { padding-top: env(safe-area-inset-top); }

        /* Alarm Animation */
        @keyframes alarmPulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .alarm-ring { animation: alarmPulse 1.5s infinite; }
    </style>
</head>
<body class="pb-24 safe-top">

    <!-- Header -->
    <header class="fixed top-0 w-full z-40 glass-panel pt-safe-top transition-transform duration-300">
        <div class="max-w-md mx-auto px-4 pt-3 pb-0">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-2xl font-bold brand-font tracking-tight text-white">TASKER<span class="text-blue-500">.</span></h1>
                    <p class="text-[10px] text-zinc-500 font-medium tracking-widest uppercase" id="quote-display">LOADING...</p>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Alarm Button -->
                    <button onclick="openAlarmModal()" class="w-9 h-9 rounded-full bg-zinc-800 flex items-center justify-center border border-zinc-700 text-zinc-400 hover:text-white hover:bg-zinc-700 transition-colors relative">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                        <div id="alarm-dot" class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full hidden"></div>
                    </button>
                    <!-- Sync Indicator -->
                    <div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center border border-zinc-700">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    </div>
                </div>
            </div>
            <!-- Tabs -->
            <div class="flex border-b border-zinc-800">
                <button onclick="switchTab('tasks')" id="tab-btn-tasks" class="flex-1 pb-3 text-sm font-medium transition-colors tab-active">Tasks</button>
                <button onclick="switchTab('stats')" id="tab-btn-stats" class="flex-1 pb-3 text-sm font-medium transition-colors tab-inactive">Performance</button>
            </div>
        </div>
    </header>

    <div class="h-32"></div>

    <!-- MAIN: TASK VIEW -->
    <main id="view-tasks" class="max-w-md mx-auto px-4 space-y-6 block will-change-transform">
        <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2" id="dayTabs"></div>

        <div class="glass-panel rounded-xl p-4 flex items-center justify-between premium-shadow">
            <div>
                <div class="text-xs text-zinc-500 uppercase font-bold tracking-wider">Daily Goal</div>
                <div class="text-xl font-bold text-white" id="mini-progress-text">0%</div>
            </div>
            <div class="w-24 h-2 bg-zinc-800 rounded-full overflow-hidden">
                <div id="mini-progress-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <div id="slots-container" class="space-y-4"></div>
        
        <!-- Next Alarm Display -->
        <div id="next-alarm-display" class="hidden text-center mt-6 p-2 bg-zinc-900/50 rounded-lg border border-zinc-800">
            <p class="text-[10px] text-zinc-500 uppercase font-bold">Next Alarm set for</p>
            <p class="text-lg font-mono text-white" id="alarm-time-display">--:--</p>
        </div>

        <div class="h-10 text-center text-zinc-700 text-xs mt-4">TASKER v7.0 ‚Ä¢ ULTRA PERFORMANCE</div>
    </main>

    <!-- MAIN: STATS VIEW -->
    <main id="view-stats" class="max-w-md mx-auto px-4 space-y-6 hidden anim-entry">
        <div class="glass-panel rounded-2xl p-6 text-center premium-shadow border-blue-500/20 border">
            <div class="text-xs text-blue-400 font-bold uppercase tracking-widest mb-2">AI Performance Insight</div>
            <div class="text-3xl font-bold text-white mb-1" id="stats-score">0%</div>
            <p class="text-sm text-zinc-400" id="stats-msg">Calculating...</p>
        </div>
        <div class="glass-panel rounded-2xl p-4">
            <canvas id="performanceChart" height="200"></canvas>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-zinc-900 rounded-xl p-4 border border-zinc-800">
                <div class="text-zinc-500 text-xs mb-1">Total Tasks</div>
                <div class="text-2xl font-bold text-white" id="stat-total">0</div>
            </div>
            <div class="bg-zinc-900 rounded-xl p-4 border border-zinc-800">
                <div class="text-zinc-500 text-xs mb-1">Completed</div>
                <div class="text-2xl font-bold text-emerald-400" id="stat-done">0</div>
            </div>
        </div>
    </main>

    <!-- RESCHEDULE MODAL -->
    <div id="schedule-modal" class="fixed inset-0 z-[60] hidden flex-col justify-end sm:justify-center bg-black/80 backdrop-blur-sm">
        <div class="w-full sm:max-w-md mx-auto glass-panel p-6 rounded-t-2xl sm:rounded-2xl shadow-2xl border-t border-blue-500/50 anim-entry">
            <div class="flex justify-between items-center mb-6">
                <div><h3 class="text-lg font-bold text-white">üöÄ Reschedule</h3><p class="text-xs text-blue-300 font-mono">Move task to another day</p></div>
                <button onclick="closeModal('schedule-modal')" class="text-zinc-400 bg-zinc-800 p-2 rounded-full">‚úï</button>
            </div>
            <div class="space-y-4 mb-6">
                <div><label class="block text-xs text-zinc-400 mb-1 uppercase font-bold">Target Day</label><select id="modal-day-select" class="w-full bg-zinc-900 border border-zinc-700 rounded-xl p-3 text-white text-sm"></select></div>
                <div><label class="block text-xs text-zinc-400 mb-1 uppercase font-bold">Target Slot</label><select id="modal-slot-select" class="w-full bg-zinc-900 border border-zinc-700 rounded-xl p-3 text-white text-sm"><option value="0">Morning Grind</option><option value="1">GK & Strategy</option><option value="2">Deep Theory</option><option value="3">Night Review</option></select></div>
            </div>
            <button onclick="confirmSchedule()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3.5 rounded-xl">Confirm Move</button>
        </div>
    </div>

    <!-- ALARM SET MODAL -->
    <div id="alarm-modal" class="fixed inset-0 z-[60] hidden flex-col justify-center items-center bg-black/80 backdrop-blur-sm">
        <div class="w-11/12 max-w-sm glass-panel p-6 rounded-2xl shadow-2xl border border-zinc-700 anim-entry">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">‚è∞ Set Alarm</h3>
                <button onclick="closeModal('alarm-modal')" class="text-zinc-400 hover:text-white">‚úï</button>
            </div>
            
            <div class="flex justify-center mb-8">
                <input type="time" id="alarm-time-input" class="bg-zinc-900 text-white text-4xl p-4 rounded-xl border border-zinc-700 focus:border-blue-500 outline-none font-mono">
            </div>

            <div class="flex items-center justify-between mb-6 bg-zinc-900/50 p-3 rounded-lg">
                <span class="text-sm text-zinc-300">Enable Alarm</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="alarm-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>

            <button onclick="saveAlarm()" class="w-full bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200 transition-colors">Save Alarm</button>
        </div>
    </div>

    <!-- ALARM RINGING SCREEN -->
    <div id="alarm-ringing-screen" class="fixed inset-0 z-[100] hidden flex-col justify-center items-center bg-red-900/90 backdrop-blur-md">
        <div class="alarm-ring w-40 h-40 rounded-full bg-red-600 flex items-center justify-center mb-8 shadow-2xl">
            <svg class="w-20 h-20 text-white animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
        </div>
        <h1 class="text-5xl font-bold text-white mb-2 tracking-tighter brand-font">WAKE UP!</h1>
        <p class="text-red-200 text-lg mb-10">Time to grind.</p>
        <button onclick="stopAlarm()" class="px-10 py-4 bg-white text-red-900 font-bold text-xl rounded-full shadow-lg hover:scale-105 transition-transform">STOP ALARM</button>
    </div>

    <!-- Confetti Canvas -->
    <canvas id="confetti" class="fixed inset-0 pointer-events-none z-[50]"></canvas>

    <script>
        const QUOTES = ["Discipline is doing what needs to be done.", "Your future is created by what you do today.", "Don't stop when you're tired. Stop when you're done.", "Focus on the process.", "Small steps lead to big results."];
        const CORE_TASKS = ["DC Generator", "DC Motor", "Alternator", "1-Phase Motor", "3-Phase Induction"];
        
        // State Initialization
        let appState = JSON.parse(localStorage.getItem('tasker_v7')) || { 
            currentDay: 0, 
            alarm: { time: "", enabled: false }, // New Alarm State
            days: Array.from({ length: 7 }, (_, i) => ({ 
                id: i, date: 4 + i, 
                slots: [ 
                    { id: 's1', title: 'Morning Grind (04-07 AM)', tasks: CORE_TASKS.map(t => ({id: Date.now()+Math.random(), text: t, done: false})) }, 
                    { id: 's2', title: 'GK & Strategy (09-02 PM)', tasks: [] }, 
                    { id: 's3', title: 'Deep Theory (02:30-07 PM)', tasks: [] }, 
                    { id: 's4', title: 'Night Review (08-10 PM)', tasks: [] } 
                ] 
            })) 
        };

        let pendingTask = null;
        let alarmInterval = null;
        let isRinging = false;

        // --- üéµ SOUND ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const playSound = (type) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); 
            const gain = audioCtx.createGain(); 
            const now = audioCtx.currentTime;
            
            if (type === 'click') { 
                osc.frequency.setValueAtTime(600, now); gain.gain.setValueAtTime(0.05, now); osc.start(); osc.stop(now + 0.05); 
            } else if (type === 'done') { 
                osc.type = 'triangle'; osc.frequency.setValueAtTime(500, now); osc.frequency.linearRampToValueAtTime(1000, now + 0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3); osc.start(); osc.stop(now + 0.3); triggerConfetti(); 
            } else if (type === 'alarm') {
                // LOUD ALARM SOUND
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.linearRampToValueAtTime(400, now + 0.5);
                gain.gain.setValueAtTime(0.5, now);
                gain.gain.linearRampToValueAtTime(0.5, now + 0.5);
                osc.start(); osc.stop(now + 0.5);
            }
            osc.connect(gain); gain.connect(audioCtx.destination);
        };

        const save = () => { localStorage.setItem('tasker_v7', JSON.stringify(appState)); updateUI(); };
        
        // --- ‚è∞ ALARM LOGIC ---
        function openAlarmModal() {
            document.getElementById('alarm-time-input').value = appState.alarm.time;
            document.getElementById('alarm-toggle').checked = appState.alarm.enabled;
            document.getElementById('alarm-modal').classList.remove('hidden');
            document.getElementById('alarm-modal').classList.add('flex');
        }

        function saveAlarm() {
            const time = document.getElementById('alarm-time-input').value;
            const enabled = document.getElementById('alarm-toggle').checked;
            appState.alarm = { time, enabled };
            save();
            closeModal('alarm-modal');
            checkAlarmDot();
        }

        function checkAlarmDot() {
            const dot = document.getElementById('alarm-dot');
            const display = document.getElementById('next-alarm-display');
            const timeDisp = document.getElementById('alarm-time-display');
            
            if(appState.alarm.enabled && appState.alarm.time) {
                dot.classList.remove('hidden');
                display.classList.remove('hidden');
                timeDisp.innerText = appState.alarm.time;
            } else {
                dot.classList.add('hidden');
                display.classList.add('hidden');
            }
        }

        function startAlarmLoop() {
            if(alarmInterval) clearInterval(alarmInterval);
            alarmInterval = setInterval(() => {
                if(!appState.alarm.enabled || !appState.alarm.time || isRinging) return;
                
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                
                if(currentTime === appState.alarm.time && now.getSeconds() < 2) {
                    triggerAlarm();
                }
            }, 1000);
        }

        let ringLoop = null;
        function triggerAlarm() {
            isRinging = true;
            document.getElementById('alarm-ringing-screen').classList.remove('hidden');
            document.getElementById('alarm-ringing-screen').classList.add('flex');
            
            // Play sound loop
            playSound('alarm');
            ringLoop = setInterval(() => playSound('alarm'), 800);
        }

        function stopAlarm() {
            isRinging = false;
            clearInterval(ringLoop);
            document.getElementById('alarm-ringing-screen').classList.add('hidden');
            document.getElementById('alarm-ringing-screen').classList.remove('flex');
        }

        // --- CORE FUNCTIONS (Unchanged logic) ---
        const toggleTask = (d, s, t) => { const task = appState.days[d].slots[s].tasks.find(x => x.id === t); task.done = !task.done; playSound(task.done ? 'done' : 'click'); save(); };
        const deleteTask = (d, s, t, e) => { e.stopPropagation(); if(confirm('Remove?')) { const sl = appState.days[d].slots[s]; sl.tasks = sl.tasks.filter(x => x.id !== t); save(); } };
        const addTask = (d, s, i) => { const v = document.getElementById(i).value.trim(); if(v) { appState.days[d].slots[s].tasks.push({id: Date.now(), text: v, done: false}); document.getElementById(i).value = ''; playSound('click'); save(); } };

        // Schedule Logic
        const initSchedule = (d, s, t, e) => {
            e.stopPropagation();
            const task = appState.days[d].slots[s].tasks.find(x => x.id === t);
            pendingTask = { text: task.text, oldD: d, oldS: s, oldId: t };
            const sel = document.getElementById('modal-day-select');
            sel.innerHTML = appState.days.map((day, i) => `<option value="${i}">Day ${i+1} (${day.date}th) ${i===d?'(Current)':''}</option>`).join('');
            sel.value = d; document.getElementById('modal-slot-select').value = s;
            document.getElementById('schedule-modal').classList.remove('hidden');
            document.getElementById('schedule-modal').classList.add('flex');
        };
        const closeModal = (id) => { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); };
        const confirmSchedule = () => {
            if(!pendingTask) return;
            const newD = parseInt(document.getElementById('modal-day-select').value);
            const newS = parseInt(document.getElementById('modal-slot-select').value);
            appState.days[newD].slots[newS].tasks.push({ id: Date.now(), text: pendingTask.text, done: false, isRescheduled: true });
            const oldTask = appState.days[pendingTask.oldD].slots[pendingTask.oldS].tasks.find(t => t.id === pendingTask.oldId);
            if(oldTask) oldTask.hasScheduledCopy = true;
            save(); closeModal('schedule-modal'); playSound('done');
        };

        // Render Logic
        const updateUI = () => {
            const curD = appState.days[appState.currentDay];
            document.getElementById('dayTabs').innerHTML = appState.days.map((d, i) => {
                const ts = d.slots.flatMap(s=>s.tasks); const p = ts.length ? (ts.filter(t=>t.done).l
